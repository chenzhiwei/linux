# auth.file format
# username:encrypted_password
# encrypted_password can be generated by `openssl passwd`
server {
    listen          80 default_server;
    server_name     auth.com www.auth.com;
    access_log      logs/auth.com.access.log main;
    location / {
        auth_basic "Restricted";
        auth_basic_user_file auth.file;
        index index.html;
        root  /var/www/htdocs/domain1.com;
    }
}

server {
    listen  443 ssl;
    http2   on;
    server_name auth.com;

    ssl_protocols   TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers   on;
    ssl_certificate     /etc/nginx/pki/tls.crt;
    ssl_certificate_key /etc/nginx/pki/tls.key;

    satisfy any; # either IP rule or basic auth

    # IP rule
    allow   10.0.0.0/8;
    allow   127.0.0.0/8;
    allow   172.16.0.0/12;
    allow   192.168.0.0/16;
    deny    all;

    # Basic Authentication
    auth_basic  "Restricted";
    auth_basic_user_file    /etc/nginx/secret/auth.file;

    location /public {
        auth_basic off;
        index index.html;
        root  /var/www/htdocs/domain1.com;
    }

    location / {
        index index.html;
        root  /var/www/htdocs/domain1.com;
    }
}
